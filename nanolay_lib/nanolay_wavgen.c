/* ************************************************************************** */
// Nanolay - Wave Generator Library Source File
//
// Description:     Custom dsPIC33CK library for SCCP functions. Should be
//                  included in the nanolay.h file
//
// Target Device:   dsPIC33CKxxxMP202  
//
// Author:          Mark Angelo Tarvina (mttarvina)
// Email:           mttarvina@gmail.com
// Revision:        1.0
// Last Updated:    25.Feb.2023
/* ************************************************************************** */

#include "nanolay_wavgen.h"


uint_fast16_t sineTable[SAMPLE_SIZE] = {
0x0800,0x0807,0x080e,0x0815,0x081c,0x0824,0x082b,0x0832,0x0839,0x0841,0x0848,0x084f,0x0856,0x085e,0x0865,0x086c,
0x0873,0x087a,0x0882,0x0889,0x0890,0x0897,0x089e,0x08a6,0x08ad,0x08b4,0x08bb,0x08c2,0x08ca,0x08d1,0x08d8,0x08df,
0x08e6,0x08ee,0x08f5,0x08fc,0x0903,0x090a,0x0911,0x0919,0x0920,0x0927,0x092e,0x0935,0x093c,0x0943,0x094b,0x0952,
0x0959,0x0960,0x0967,0x096e,0x0975,0x097c,0x0983,0x098a,0x0991,0x0998,0x09a0,0x09a7,0x09ae,0x09b5,0x09bc,0x09c3,
0x09ca,0x09d1,0x09d8,0x09df,0x09e6,0x09ed,0x09f4,0x09fb,0x0a02,0x0a08,0x0a0f,0x0a16,0x0a1d,0x0a24,0x0a2b,0x0a32,
0x0a39,0x0a40,0x0a47,0x0a4d,0x0a54,0x0a5b,0x0a62,0x0a69,0x0a70,0x0a76,0x0a7d,0x0a84,0x0a8b,0x0a92,0x0a98,0x0a9f,
0x0aa6,0x0aac,0x0ab3,0x0aba,0x0ac1,0x0ac7,0x0ace,0x0ad5,0x0adb,0x0ae2,0x0ae9,0x0aef,0x0af6,0x0afc,0x0b03,0x0b09,
0x0b10,0x0b17,0x0b1d,0x0b24,0x0b2a,0x0b31,0x0b37,0x0b3e,0x0b44,0x0b4a,0x0b51,0x0b57,0x0b5e,0x0b64,0x0b6a,0x0b71,
0x0b77,0x0b7d,0x0b84,0x0b8a,0x0b90,0x0b97,0x0b9d,0x0ba3,0x0ba9,0x0bb0,0x0bb6,0x0bbc,0x0bc2,0x0bc8,0x0bcf,0x0bd5,
0x0bdb,0x0be1,0x0be7,0x0bed,0x0bf3,0x0bf9,0x0bff,0x0c05,0x0c0b,0x0c11,0x0c17,0x0c1d,0x0c23,0x0c29,0x0c2f,0x0c35,
0x0c3a,0x0c40,0x0c46,0x0c4c,0x0c52,0x0c58,0x0c5d,0x0c63,0x0c69,0x0c6e,0x0c74,0x0c7a,0x0c80,0x0c85,0x0c8b,0x0c90,
0x0c96,0x0c9c,0x0ca1,0x0ca7,0x0cac,0x0cb2,0x0cb7,0x0cbd,0x0cc2,0x0cc7,0x0ccd,0x0cd2,0x0cd8,0x0cdd,0x0ce2,0x0ce7,
0x0ced,0x0cf2,0x0cf7,0x0cfd,0x0d02,0x0d07,0x0d0c,0x0d11,0x0d16,0x0d1b,0x0d21,0x0d26,0x0d2b,0x0d30,0x0d35,0x0d3a,
0x0d3f,0x0d44,0x0d48,0x0d4d,0x0d52,0x0d57,0x0d5c,0x0d61,0x0d66,0x0d6a,0x0d6f,0x0d74,0x0d79,0x0d7d,0x0d82,0x0d87,
0x0d8b,0x0d90,0x0d94,0x0d99,0x0d9d,0x0da2,0x0da6,0x0dab,0x0daf,0x0db4,0x0db8,0x0dbd,0x0dc1,0x0dc5,0x0dca,0x0dce,
0x0dd2,0x0dd6,0x0ddb,0x0ddf,0x0de3,0x0de7,0x0deb,0x0def,0x0df3,0x0df7,0x0dfb,0x0dff,0x0e03,0x0e07,0x0e0b,0x0e0f,
0x0e13,0x0e17,0x0e1b,0x0e1f,0x0e22,0x0e26,0x0e2a,0x0e2e,0x0e31,0x0e35,0x0e39,0x0e3c,0x0e40,0x0e44,0x0e47,0x0e4b,
0x0e4e,0x0e52,0x0e55,0x0e58,0x0e5c,0x0e5f,0x0e63,0x0e66,0x0e69,0x0e6c,0x0e70,0x0e73,0x0e76,0x0e79,0x0e7c,0x0e80,
0x0e83,0x0e86,0x0e89,0x0e8c,0x0e8f,0x0e92,0x0e95,0x0e98,0x0e9a,0x0e9d,0x0ea0,0x0ea3,0x0ea6,0x0ea9,0x0eab,0x0eae,
0x0eb1,0x0eb3,0x0eb6,0x0eb8,0x0ebb,0x0ebe,0x0ec0,0x0ec3,0x0ec5,0x0ec8,0x0eca,0x0ecc,0x0ecf,0x0ed1,0x0ed3,0x0ed6,
0x0ed8,0x0eda,0x0edc,0x0ede,0x0ee1,0x0ee3,0x0ee5,0x0ee7,0x0ee9,0x0eeb,0x0eed,0x0eef,0x0ef1,0x0ef3,0x0ef4,0x0ef6,
0x0ef8,0x0efa,0x0efc,0x0efd,0x0eff,0x0f01,0x0f02,0x0f04,0x0f06,0x0f07,0x0f09,0x0f0a,0x0f0c,0x0f0d,0x0f0f,0x0f10,
0x0f11,0x0f13,0x0f14,0x0f15,0x0f17,0x0f18,0x0f19,0x0f1a,0x0f1b,0x0f1c,0x0f1e,0x0f1f,0x0f20,0x0f21,0x0f22,0x0f23,
0x0f23,0x0f24,0x0f25,0x0f26,0x0f27,0x0f28,0x0f28,0x0f29,0x0f2a,0x0f2a,0x0f2b,0x0f2c,0x0f2c,0x0f2d,0x0f2d,0x0f2e,
0x0f2e,0x0f2f,0x0f2f,0x0f30,0x0f30,0x0f30,0x0f31,0x0f31,0x0f31,0x0f31,0x0f31,0x0f32,0x0f32,0x0f32,0x0f32,0x0f32,
0x0f32,0x0f32,0x0f32,0x0f32,0x0f32,0x0f32,0x0f31,0x0f31,0x0f31,0x0f31,0x0f31,0x0f30,0x0f30,0x0f30,0x0f2f,0x0f2f,
0x0f2e,0x0f2e,0x0f2d,0x0f2d,0x0f2c,0x0f2c,0x0f2b,0x0f2a,0x0f2a,0x0f29,0x0f28,0x0f28,0x0f27,0x0f26,0x0f25,0x0f24,
0x0f23,0x0f23,0x0f22,0x0f21,0x0f20,0x0f1f,0x0f1e,0x0f1c,0x0f1b,0x0f1a,0x0f19,0x0f18,0x0f17,0x0f15,0x0f14,0x0f13,
0x0f11,0x0f10,0x0f0f,0x0f0d,0x0f0c,0x0f0a,0x0f09,0x0f07,0x0f06,0x0f04,0x0f02,0x0f01,0x0eff,0x0efd,0x0efc,0x0efa,
0x0ef8,0x0ef6,0x0ef4,0x0ef3,0x0ef1,0x0eef,0x0eed,0x0eeb,0x0ee9,0x0ee7,0x0ee5,0x0ee3,0x0ee1,0x0ede,0x0edc,0x0eda,
0x0ed8,0x0ed6,0x0ed3,0x0ed1,0x0ecf,0x0ecc,0x0eca,0x0ec8,0x0ec5,0x0ec3,0x0ec0,0x0ebe,0x0ebb,0x0eb8,0x0eb6,0x0eb3,
0x0eb1,0x0eae,0x0eab,0x0ea9,0x0ea6,0x0ea3,0x0ea0,0x0e9d,0x0e9a,0x0e98,0x0e95,0x0e92,0x0e8f,0x0e8c,0x0e89,0x0e86,
0x0e83,0x0e80,0x0e7c,0x0e79,0x0e76,0x0e73,0x0e70,0x0e6c,0x0e69,0x0e66,0x0e63,0x0e5f,0x0e5c,0x0e58,0x0e55,0x0e52,
0x0e4e,0x0e4b,0x0e47,0x0e44,0x0e40,0x0e3c,0x0e39,0x0e35,0x0e31,0x0e2e,0x0e2a,0x0e26,0x0e22,0x0e1f,0x0e1b,0x0e17,
0x0e13,0x0e0f,0x0e0b,0x0e07,0x0e03,0x0dff,0x0dfb,0x0df7,0x0df3,0x0def,0x0deb,0x0de7,0x0de3,0x0ddf,0x0ddb,0x0dd6,
0x0dd2,0x0dce,0x0dca,0x0dc5,0x0dc1,0x0dbd,0x0db8,0x0db4,0x0daf,0x0dab,0x0da6,0x0da2,0x0d9d,0x0d99,0x0d94,0x0d90,
0x0d8b,0x0d87,0x0d82,0x0d7d,0x0d79,0x0d74,0x0d6f,0x0d6a,0x0d66,0x0d61,0x0d5c,0x0d57,0x0d52,0x0d4d,0x0d48,0x0d44,
0x0d3f,0x0d3a,0x0d35,0x0d30,0x0d2b,0x0d26,0x0d21,0x0d1b,0x0d16,0x0d11,0x0d0c,0x0d07,0x0d02,0x0cfd,0x0cf7,0x0cf2,
0x0ced,0x0ce7,0x0ce2,0x0cdd,0x0cd8,0x0cd2,0x0ccd,0x0cc7,0x0cc2,0x0cbd,0x0cb7,0x0cb2,0x0cac,0x0ca7,0x0ca1,0x0c9c,
0x0c96,0x0c90,0x0c8b,0x0c85,0x0c80,0x0c7a,0x0c74,0x0c6e,0x0c69,0x0c63,0x0c5d,0x0c58,0x0c52,0x0c4c,0x0c46,0x0c40,
0x0c3a,0x0c35,0x0c2f,0x0c29,0x0c23,0x0c1d,0x0c17,0x0c11,0x0c0b,0x0c05,0x0bff,0x0bf9,0x0bf3,0x0bed,0x0be7,0x0be1,
0x0bdb,0x0bd5,0x0bcf,0x0bc8,0x0bc2,0x0bbc,0x0bb6,0x0bb0,0x0ba9,0x0ba3,0x0b9d,0x0b97,0x0b90,0x0b8a,0x0b84,0x0b7d,
0x0b77,0x0b71,0x0b6a,0x0b64,0x0b5e,0x0b57,0x0b51,0x0b4a,0x0b44,0x0b3e,0x0b37,0x0b31,0x0b2a,0x0b24,0x0b1d,0x0b17,
0x0b10,0x0b09,0x0b03,0x0afc,0x0af6,0x0aef,0x0ae9,0x0ae2,0x0adb,0x0ad5,0x0ace,0x0ac7,0x0ac1,0x0aba,0x0ab3,0x0aac,
0x0aa6,0x0a9f,0x0a98,0x0a92,0x0a8b,0x0a84,0x0a7d,0x0a76,0x0a70,0x0a69,0x0a62,0x0a5b,0x0a54,0x0a4d,0x0a47,0x0a40,
0x0a39,0x0a32,0x0a2b,0x0a24,0x0a1d,0x0a16,0x0a0f,0x0a08,0x0a02,0x09fb,0x09f4,0x09ed,0x09e6,0x09df,0x09d8,0x09d1,
0x09ca,0x09c3,0x09bc,0x09b5,0x09ae,0x09a7,0x09a0,0x0998,0x0991,0x098a,0x0983,0x097c,0x0975,0x096e,0x0967,0x0960,
0x0959,0x0952,0x094b,0x0943,0x093c,0x0935,0x092e,0x0927,0x0920,0x0919,0x0911,0x090a,0x0903,0x08fc,0x08f5,0x08ee,
0x08e6,0x08df,0x08d8,0x08d1,0x08ca,0x08c2,0x08bb,0x08b4,0x08ad,0x08a6,0x089e,0x0897,0x0890,0x0889,0x0882,0x087a,
0x0873,0x086c,0x0865,0x085e,0x0856,0x084f,0x0848,0x0841,0x0839,0x0832,0x082b,0x0824,0x081c,0x0815,0x080e,0x0807,
0x0800,0x07f8,0x07f1,0x07ea,0x07e3,0x07db,0x07d4,0x07cd,0x07c6,0x07be,0x07b7,0x07b0,0x07a9,0x07a1,0x079a,0x0793,
0x078c,0x0785,0x077d,0x0776,0x076f,0x0768,0x0761,0x0759,0x0752,0x074b,0x0744,0x073d,0x0735,0x072e,0x0727,0x0720,
0x0719,0x0711,0x070a,0x0703,0x06fc,0x06f5,0x06ee,0x06e6,0x06df,0x06d8,0x06d1,0x06ca,0x06c3,0x06bc,0x06b4,0x06ad,
0x06a6,0x069f,0x0698,0x0691,0x068a,0x0683,0x067c,0x0675,0x066e,0x0667,0x065f,0x0658,0x0651,0x064a,0x0643,0x063c,
0x0635,0x062e,0x0627,0x0620,0x0619,0x0612,0x060b,0x0604,0x05fd,0x05f7,0x05f0,0x05e9,0x05e2,0x05db,0x05d4,0x05cd,
0x05c6,0x05bf,0x05b8,0x05b2,0x05ab,0x05a4,0x059d,0x0596,0x058f,0x0589,0x0582,0x057b,0x0574,0x056d,0x0567,0x0560,
0x0559,0x0553,0x054c,0x0545,0x053e,0x0538,0x0531,0x052a,0x0524,0x051d,0x0516,0x0510,0x0509,0x0503,0x04fc,0x04f6,
0x04ef,0x04e8,0x04e2,0x04db,0x04d5,0x04ce,0x04c8,0x04c1,0x04bb,0x04b5,0x04ae,0x04a8,0x04a1,0x049b,0x0495,0x048e,
0x0488,0x0482,0x047b,0x0475,0x046f,0x0468,0x0462,0x045c,0x0456,0x044f,0x0449,0x0443,0x043d,0x0437,0x0430,0x042a,
0x0424,0x041e,0x0418,0x0412,0x040c,0x0406,0x0400,0x03fa,0x03f4,0x03ee,0x03e8,0x03e2,0x03dc,0x03d6,0x03d0,0x03ca,
0x03c5,0x03bf,0x03b9,0x03b3,0x03ad,0x03a7,0x03a2,0x039c,0x0396,0x0391,0x038b,0x0385,0x037f,0x037a,0x0374,0x036f,
0x0369,0x0363,0x035e,0x0358,0x0353,0x034d,0x0348,0x0342,0x033d,0x0338,0x0332,0x032d,0x0327,0x0322,0x031d,0x0318,
0x0312,0x030d,0x0308,0x0302,0x02fd,0x02f8,0x02f3,0x02ee,0x02e9,0x02e4,0x02de,0x02d9,0x02d4,0x02cf,0x02ca,0x02c5,
0x02c0,0x02bb,0x02b7,0x02b2,0x02ad,0x02a8,0x02a3,0x029e,0x0299,0x0295,0x0290,0x028b,0x0286,0x0282,0x027d,0x0278,
0x0274,0x026f,0x026b,0x0266,0x0262,0x025d,0x0259,0x0254,0x0250,0x024b,0x0247,0x0242,0x023e,0x023a,0x0235,0x0231,
0x022d,0x0229,0x0224,0x0220,0x021c,0x0218,0x0214,0x0210,0x020c,0x0208,0x0204,0x0200,0x01fc,0x01f8,0x01f4,0x01f0,
0x01ec,0x01e8,0x01e4,0x01e0,0x01dd,0x01d9,0x01d5,0x01d1,0x01ce,0x01ca,0x01c6,0x01c3,0x01bf,0x01bb,0x01b8,0x01b4,
0x01b1,0x01ad,0x01aa,0x01a7,0x01a3,0x01a0,0x019c,0x0199,0x0196,0x0193,0x018f,0x018c,0x0189,0x0186,0x0183,0x017f,
0x017c,0x0179,0x0176,0x0173,0x0170,0x016d,0x016a,0x0167,0x0165,0x0162,0x015f,0x015c,0x0159,0x0156,0x0154,0x0151,
0x014e,0x014c,0x0149,0x0147,0x0144,0x0141,0x013f,0x013c,0x013a,0x0137,0x0135,0x0133,0x0130,0x012e,0x012c,0x0129,
0x0127,0x0125,0x0123,0x0121,0x011e,0x011c,0x011a,0x0118,0x0116,0x0114,0x0112,0x0110,0x010e,0x010c,0x010b,0x0109,
0x0107,0x0105,0x0103,0x0102,0x0100,0x00fe,0x00fd,0x00fb,0x00f9,0x00f8,0x00f6,0x00f5,0x00f3,0x00f2,0x00f0,0x00ef,
0x00ee,0x00ec,0x00eb,0x00ea,0x00e8,0x00e7,0x00e6,0x00e5,0x00e4,0x00e3,0x00e1,0x00e0,0x00df,0x00de,0x00dd,0x00dc,
0x00dc,0x00db,0x00da,0x00d9,0x00d8,0x00d7,0x00d7,0x00d6,0x00d5,0x00d5,0x00d4,0x00d3,0x00d3,0x00d2,0x00d2,0x00d1,
0x00d1,0x00d0,0x00d0,0x00cf,0x00cf,0x00cf,0x00ce,0x00ce,0x00ce,0x00ce,0x00ce,0x00cd,0x00cd,0x00cd,0x00cd,0x00cd,
0x00cd,0x00cd,0x00cd,0x00cd,0x00cd,0x00cd,0x00ce,0x00ce,0x00ce,0x00ce,0x00ce,0x00cf,0x00cf,0x00cf,0x00d0,0x00d0,
0x00d1,0x00d1,0x00d2,0x00d2,0x00d3,0x00d3,0x00d4,0x00d5,0x00d5,0x00d6,0x00d7,0x00d7,0x00d8,0x00d9,0x00da,0x00db,
0x00dc,0x00dc,0x00dd,0x00de,0x00df,0x00e0,0x00e1,0x00e3,0x00e4,0x00e5,0x00e6,0x00e7,0x00e8,0x00ea,0x00eb,0x00ec,
0x00ee,0x00ef,0x00f0,0x00f2,0x00f3,0x00f5,0x00f6,0x00f8,0x00f9,0x00fb,0x00fd,0x00fe,0x0100,0x0102,0x0103,0x0105,
0x0107,0x0109,0x010b,0x010c,0x010e,0x0110,0x0112,0x0114,0x0116,0x0118,0x011a,0x011c,0x011e,0x0121,0x0123,0x0125,
0x0127,0x0129,0x012c,0x012e,0x0130,0x0133,0x0135,0x0137,0x013a,0x013c,0x013f,0x0141,0x0144,0x0147,0x0149,0x014c,
0x014e,0x0151,0x0154,0x0156,0x0159,0x015c,0x015f,0x0162,0x0165,0x0167,0x016a,0x016d,0x0170,0x0173,0x0176,0x0179,
0x017c,0x017f,0x0183,0x0186,0x0189,0x018c,0x018f,0x0193,0x0196,0x0199,0x019c,0x01a0,0x01a3,0x01a7,0x01aa,0x01ad,
0x01b1,0x01b4,0x01b8,0x01bb,0x01bf,0x01c3,0x01c6,0x01ca,0x01ce,0x01d1,0x01d5,0x01d9,0x01dd,0x01e0,0x01e4,0x01e8,
0x01ec,0x01f0,0x01f4,0x01f8,0x01fc,0x0200,0x0204,0x0208,0x020c,0x0210,0x0214,0x0218,0x021c,0x0220,0x0224,0x0229,
0x022d,0x0231,0x0235,0x023a,0x023e,0x0242,0x0247,0x024b,0x0250,0x0254,0x0259,0x025d,0x0262,0x0266,0x026b,0x026f,
0x0274,0x0278,0x027d,0x0282,0x0286,0x028b,0x0290,0x0295,0x0299,0x029e,0x02a3,0x02a8,0x02ad,0x02b2,0x02b7,0x02bb,
0x02c0,0x02c5,0x02ca,0x02cf,0x02d4,0x02d9,0x02de,0x02e4,0x02e9,0x02ee,0x02f3,0x02f8,0x02fd,0x0302,0x0308,0x030d,
0x0312,0x0318,0x031d,0x0322,0x0327,0x032d,0x0332,0x0338,0x033d,0x0342,0x0348,0x034d,0x0353,0x0358,0x035e,0x0363,
0x0369,0x036f,0x0374,0x037a,0x037f,0x0385,0x038b,0x0391,0x0396,0x039c,0x03a2,0x03a7,0x03ad,0x03b3,0x03b9,0x03bf,
0x03c5,0x03ca,0x03d0,0x03d6,0x03dc,0x03e2,0x03e8,0x03ee,0x03f4,0x03fa,0x0400,0x0406,0x040c,0x0412,0x0418,0x041e,
0x0424,0x042a,0x0430,0x0437,0x043d,0x0443,0x0449,0x044f,0x0456,0x045c,0x0462,0x0468,0x046f,0x0475,0x047b,0x0482,
0x0488,0x048e,0x0495,0x049b,0x04a1,0x04a8,0x04ae,0x04b5,0x04bb,0x04c1,0x04c8,0x04ce,0x04d5,0x04db,0x04e2,0x04e8,
0x04ef,0x04f6,0x04fc,0x0503,0x0509,0x0510,0x0516,0x051d,0x0524,0x052a,0x0531,0x0538,0x053e,0x0545,0x054c,0x0553,
0x0559,0x0560,0x0567,0x056d,0x0574,0x057b,0x0582,0x0589,0x058f,0x0596,0x059d,0x05a4,0x05ab,0x05b2,0x05b8,0x05bf,
0x05c6,0x05cd,0x05d4,0x05db,0x05e2,0x05e9,0x05f0,0x05f7,0x05fd,0x0604,0x060b,0x0612,0x0619,0x0620,0x0627,0x062e,
0x0635,0x063c,0x0643,0x064a,0x0651,0x0658,0x065f,0x0667,0x066e,0x0675,0x067c,0x0683,0x068a,0x0691,0x0698,0x069f,
0x06a6,0x06ad,0x06b4,0x06bc,0x06c3,0x06ca,0x06d1,0x06d8,0x06df,0x06e6,0x06ee,0x06f5,0x06fc,0x0703,0x070a,0x0711,
0x0719,0x0720,0x0727,0x072e,0x0735,0x073d,0x0744,0x074b,0x0752,0x0759,0x0761,0x0768,0x076f,0x0776,0x077d,0x0785,
0x078c,0x0793,0x079a,0x07a1,0x07a9,0x07b0,0x07b7,0x07be,0x07c6,0x07cd,0x07d4,0x07db,0x07e3,0x07ea,0x07f1,0x07f8
};


WAV_Sine sineWave;


void WAV_Sine_Init(bool activeOnIdle, bool activeOnSleep, uint_fast16_t freq, uint_fast32_t samplingFreq){
    GPIO_SetPortAPin(PIN3, OUTPUT, false, false, false);
    DAC_Init(activeOnIdle);

    sineWave.frequency = freq;
    sineWave.samplingFrequency = samplingFreq;
    sineWave.index = 1;
    sineWave.stepSize = (int) (SAMPLE_SIZE / (sineWave.samplingFrequency / sineWave.frequency));
    sineWave.samplingInterval = (int) (1000000 / sineWave.samplingFrequency);
    SCCP8_Init(activeOnIdle, activeOnSleep, sineWave.samplingInterval, INT_PRIORITY);
}


void WAV_Sine_Start(void){
    IFS9bits.CCT8IF = false;                                                    // clear interrupt flag
    IEC9bits.CCT8IE = true;
    CCP8CON1Lbits.CCPON = true;
}


void WAV_Sine_Stop(void){
    IEC9bits.CCT8IE = false;
    IEC9bits.CCP8IE = false;
    CCP8CON1Lbits.CCPON = false;
}


void WAV_Sine_SetFrequency(uint_fast16_t freq){
    sineWave.frequency = freq;
    sineWave.stepSize = (int) (SAMPLE_SIZE / (sineWave.samplingFrequency / sineWave.frequency));
}


void SCCP8_Init(bool activeOnIdle, bool activeOnSleep, uint_fast32_t interval_us, uint_fast8_t priority){
    IPC38bits.CCT8IP = priority;
    
    Clock_Freq clk = Sys_GetMasterClkFreq();
    uint_fast32_t val = 0;

    PMD2bits.CCP8MD = 0;                                                        // enable SCCP8 peripheral

    CCP8CON1Lbits.CCPON = false;                                                // make sure module is disabled at initialization
    CCP8CON1Lbits.CCPSIDL = !activeOnIdle;
    CCP8CON1Lbits.CCPSLP = activeOnSleep;
    CCP8CON1Lbits.CLKSEL = 0x0;                                                 // FOSC/2 is the clock source
    CCP8CON1Lbits.TMRPS = 0;                                                    // 1:1 prescaler
    CCP8CON1Lbits.TMRSYNC = 0;                                                  // sync enabled
    CCP8CON1Lbits.T32 = 1;                                                      // SCCP8 is a single 32bit timer
    CCP8CON1Lbits.CCSEL = 0;                                                    // Timer mode
    CCP8CON1Lbits.MOD = 0x0;                                                    // 16-Bit/32-Bit Timer mode, output functions are disabled

    CCP8CON1H = 0x0000;                                                         // RTRGEN disabled; ALTSYNC disabled; ONESHOT disabled; TRIGEN disabled; OPS Each Time Base Period Match; SYNC None; OPSSRC Timer Interrupt Event;
    CCP8CON2L = 0x0000;                                                         // ASDGM disabled; SSDG disabled; ASDG 0; PWMRSEN disabled; 
    CCP8CON2H = 0x0000;                                                         // ICGSM Level-Sensitive mode; ICSEL IC1; AUXOUT Disabled; OCAEN disabled; OENSYNC disabled; 
    CCP8CON3H = 0x0000;                                                         // OETRIG disabled; OSCNT None; POLACE disabled; PSSACE Tri-state; 
    CCP8STATL = 0x0000;                                                         // ICDIS disabled; SCEVT disabled; TRSET disabled; ICOV disabled; ASEVT disabled; ICGARM disabled; TRCLR disabled; 
    CCP8PRL = 0x0000;                                                           // initially set primary timer period to 0
    CCP8PRH = 0x0000;                                                           // initially set secondary timer period to 0
    CCP8TMRL = 0x00;                                                            // TMR 0; 
    CCP8TMRH = 0x00;                                                            // TMR 0; 
    CCP8RA = 0x00;                                                              // CMP 0; 
    CCP8RB = 0x00;                                                              // CMP 0;
    CCP8BUFL = 0x00;                                                            // BUF 0; 
    CCP8BUFH = 0x00;                                                            // BUF 0;

    switch( clk ){
        case FOSC_8MHZ:
            val = (interval_us * SCCP_1US_COUNT_8MHZ) - 1;
            break;
        case FOSC_20MHZ:
            val = (interval_us * SCCP_1US_COUNT_20MHZ) - 1;
            break;
        case FOSC_50MHZ:
            val = (interval_us * SCCP_1US_COUNT_50MHZ) - 1;
            break;
        case FOSC_100MHZ:
            val = (interval_us * SCCP_1US_COUNT_100MHZ) - 1;
            break;
    }
    
    CCP8PRL = (val & 0x0000FFFF);
    CCP8PRH = ((val & 0xFFFF0000) >> 16);

    IEC9bits.CCT8IE = false;
    IEC9bits.CCP8IE = false;
}


void __attribute__ ((interrupt, no_auto_psv)) _CCT8Interrupt (void){
    IFS9bits.CCT8IF = false;                                                    // clear interrupt flag

    if (sineWave.index > SAMPLE_SIZE){
        sineWave.index = 1;
    }
    DAC1DATHbits.DACDAT = sineTable[sineWave.index - 1];
    sineWave.index = sineWave.index + sineWave.stepSize;
}



void WAV_Triangle_Init(bool activeOnIdle){
    Clock_Freq clk = Sys_GetMasterClkFreq();

    if ((clk != FOSC_8MHZ)) {
		PMD7bits.CMP1MD = 0;													// enable CMP1 module

	    DACCTRL1L = 0x00; 														// CLKDIV 1:1; DACON disabled; DACSIDL disabled; FCLKDIV 1:1; CLKSEL AFVCO/2 - Auxiliary VCO Clock;        
		DACCTRL1Lbits.DACSIDL = !activeOnIdle;
	    DACCTRL2L = 0x55; 														// TMODTIME 85; 
	    DACCTRL2H = 0x8A; 														// SSTIME 138; 
	    DAC2CONH = 0x00; 														// TMCB 0; 
	    DAC2CONL = 0x00; 

	    //Slope Settings
	    SLP1CONH = 0x00; 														// HME disabled; PSE Negative; SLOPEN disabled; TWME disabled; 
	    SLP1CONL = 0x00; 														// HCFSEL None; SLPSTRT None; SLPSTOPB None; SLPSTOPA None; 
	    SLP1DAT = 0x00; 														// SLPDAT 0; 
	    DAC1DATL = 0x00; 														// DACDATL 0; 
	    DAC1DATH = 0x00; 														// DACDATH 0; 
    
		DAC1CONLbits.DACEN	= 1;												
		DAC1CONLbits.DACOEN = 1;    											// enable DACOUT pin

        DACCTRL1Lbits.DACON = 1;												// enable DAC modules
    }
}
